<!DOCTYPE html><html>
<head>
  <title>TEXNET HOME FIBER Monthly Financial Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f0f4f8;
      color: #333;
    }
    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    .header-box {
      text-align: center;
      padding: 20px;
      background-color: #0077cc;
      color: white;
      border-radius: 10px;
      margin: 10px;
    }
    .btn-group button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #0077cc;
      color: white;
      cursor: pointer;
    }
    .btn-group button:hover {
      background-color: #005fa3;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex;
      align-items: center; justify-content: center; z-index: 9999;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 10px;
      max-width: 300px; width: 100%; text-align: center;
    }
    select {
      display: block;
      margin: 0 auto;
      padding: 8px;
      font-size: 1rem;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body class="light">
<div id="loginOverlay">
  <div id="loginBox">
    <h3>Enter Password</h3>
    <input type="password" id="loginPassword"><br><br>
    <button onclick="checkPassword()">Login</button>
  </div>
</div><div id="contentToExport">
  <div class="header-box">
    <h1>TEXNET HOME FIBER</h1>
    <h2>Monthly Financial Audit</h2>
    <div class="btn-group">
      <button onclick="toggleTheme()">Toggle Dark/Light</button>
      <button onclick="downloadPDF()">Export to PDF</button>
      <button onclick="downloadExcel()">Export to Excel</button>
    </div>
    <select id="monthSelect" onchange="drawSelectedMonth()"></select>
  </div>  <table id="summaryTable"></table>
  <h3 style="text-align:center">Income Details</h3>
  <table id="incomeDetails" class="display"></table>
  <h3 style="text-align:center">Expenditure Details</h3>
  <table id="expenditureDetails" class="display"></table>
</div><script>
  const PASSWORD = "texnet123";
  const INCOME_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=280109793&single=true&output=csv";
  const EXPENSE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=1600049240&single=true&output=csv";

  let incomeMap = {}, expenseMap = {}, months = [], allIncome = [], allExpense = [];
  let selectedMonth = "";

  function checkPassword() {
    const input = document.getElementById("loginPassword").value;
    if (input === PASSWORD) {
      document.getElementById("loginOverlay").style.display = "none";
    } else {
      alert("Incorrect password");
    }
  }

  function toggleTheme() {
    const body = document.body;
    body.className = body.className === "light" ? "dark" : "light";
  }

  function formatMonth(dateStr) {
    const parts = dateStr.split(/[\/\s:]/);
    if (parts.length < 3) return null;
    const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return isNaN(date) ? null : date.toLocaleString('default', { month: 'long', year: 'numeric' });
  }

  function processData() {
    Papa.parse(INCOME_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        allIncome = results.data;
        results.data.forEach(row => {
          const month = formatMonth(row.Date);
          if (!month) return;
          if (!incomeMap[month]) incomeMap[month] = 0;
          incomeMap[month] += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });

    Papa.parse(EXPENSE_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        allExpense = results.data;
        results.data.forEach(row => {
          const month = formatMonth(row.Date);
          if (!month) return;
          if (!expenseMap[month]) expenseMap[month] = { exp: 0, cost: 0 };
          expenseMap[month].exp += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          expenseMap[month].cost += parseFloat((row["Transaction Cost"] || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });
  }

  function checkReady() {
    if (Object.keys(incomeMap).length && Object.keys(expenseMap).length) {
      populateMonthSelect();
    }
  }

  function populateMonthSelect() {
    const sel = document.getElementById("monthSelect");
    sel.innerHTML = months.sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b))
      .map(m => `<option value="${m}">${m}</option>`).join('');
    drawSelectedMonth();
  }

  function drawSelectedMonth() {
    selectedMonth = document.getElementById("monthSelect").value;
    const income = incomeMap[selectedMonth] || 0;
    const expense = expenseMap[selectedMonth]?.exp || 0;
    const cost = expenseMap[selectedMonth]?.cost || 0;
    const net = income - expense - cost;

    document.getElementById("summaryTable").innerHTML = `
      <thead><tr><th>Category</th><th>Amount (Ksh)</th></tr></thead>
      <tbody>
        <tr><td>Income</td><td>${income.toFixed(2)}</td></tr>
        <tr><td>Expenditure</td><td>${expense.toFixed(2)}</td></tr>
        <tr><td>Transaction Cost</td><td>${cost.toFixed(2)}</td></tr>
        <tr><td><strong>Net</strong></td><td><strong>${net.toFixed(2)}</strong></td></tr>
      </tbody>
    `;

    const incomeTable = $('#incomeDetails');
    const incomeRows = allIncome.filter(r => formatMonth(r.Date) === selectedMonth).map(r =>
      `<tr><td>${r.Date}</td><td>${r.Name}</td><td>${r.Amount}</td><td>${r.Phone}</td></tr>`
    ).join('');
    incomeTable.html(`<thead><tr><th>Date</th><th>Name</th><th>Amount</th><th>Phone</th></thead><tbody>${incomeRows}</tbody>`);
    if (!$.fn.DataTable.isDataTable('#incomeDetails')) incomeTable.DataTable();

    const expenseTable = $('#expenditureDetails');
    const expenseRows = allExpense.filter(r => formatMonth(r.Date) === selectedMonth).map(r =>
      `<tr><td>${r.Date}</td><td>${r.Item}</td><td>${r.Amount}</td><td>${r["Transaction Cost"] || "0.00"}</td></tr>`
    ).join('');
    expenseTable.html(`<thead><tr><th>Date</th><th>Item</th><th>Amount</th><th>Transaction Cost</th></tr></thead><tbody>${expenseRows}</tbody>`);
    if (!$.fn.DataTable.isDataTable('#expenditureDetails')) expenseTable.DataTable();
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;
    const pageHeight = pdf.internal.pageSize.height;
    pdf.setFontSize(14);
    pdf.text("TEXNET HOME FIBER - " + selectedMonth + " Financial Audit", 10, y);
    y += 10;

    pdf.setFontSize(12);
    pdf.setFont(undefined, 'bold');
    pdf.text("Summary:", 10, y);
    y += 7;
    pdf.setFont(undefined, 'normal');
    const summary = document.querySelectorAll('#summaryTable tbody tr');
    summary.forEach(row => {
      const cols = row.querySelectorAll('td');
      if (cols.length === 2) {
        pdf.text(cols[0].innerText, 12, y);
        pdf.text(cols[1].innerText, 110, y, { align: 'right' });
        y += 6;
      }
    });

    y += 8;
    pdf.setFont(undefined, 'bold');
    pdf.text("Income Details:", 10, y);
    y += 7;
    pdf.setFont(undefined, 'bold');
    pdf.text("Date", 12, y);
    pdf.text("Name", 50, y);
    pdf.text("Amount", 120, y);
    pdf.text("Phone", 160, y);
    y += 6;
    pdf.setFont(undefined, 'normal');
    const income = allIncome.filter(r => formatMonth(r.Date) === selectedMonth);
    income.forEach(r => {
      if (y > pageHeight - 10) { pdf.addPage(); y = 10; }
      pdf.text(r.Date, 12, y);
      pdf.text(r.Name || '', 50, y);
      pdf.text(r.Amount || '', 120, y);
      pdf.text(r.Phone || '', 160, y);
      y += 6;
    });

    y += 8;
    pdf.setFont(undefined, 'bold');
    pdf.text("Expenditure Details:", 10, y);
    y += 7;
    pdf.text("Date", 12, y);
    pdf.text("Item", 50, y);
    pdf.text("Amount", 120, y);
    pdf.text("Transaction Cost", 160, y);
    y += 6;
    pdf.setFont(undefined, 'normal');
    const expense = allExpense.filter(r => formatMonth(r.Date) === selectedMonth);
    expense.forEach(r => {
      if (y > pageHeight - 10) { pdf.addPage(); y = 10; }
      pdf.text(r.Date, 12, y);
      pdf.text(r.Item || '', 50, y);
      pdf.text(r.Amount || '', 120, y);
      pdf.text((r["Transaction Cost"] || '0.00'), 160, y);
      y += 6;
    });

    pdf.save(`TEXNET-${selectedMonth.replace(/ /g, '_')}-Audit.pdf`);
  }

  function downloadExcel() {
    const incomeData = [
      ["Income Details"],
      ["Date", "Name", "Amount", "Phone"],
      ...allIncome.map(row => [row.Date, row.Name, row.Amount, row.Phone])
    ];

    const expenseData = [
      ["Expenditure Details"],
      ["Date", "Item", "Amount", "Transaction Cost"],
      ...allExpense.map(row => [row.Date, row.Item, row.Amount, row["Transaction Cost"]])
    ];

    const wb = XLSX.utils.book_new();
    const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
    const wsExpense = XLSX.utils.aoa_to_sheet(expenseData);

    XLSX.utils.book_append_sheet(wb, wsIncome, "Income");
    XLSX.utils.book_append_sheet(wb, wsExpense, "Expenditure");

    XLSX.writeFile(wb, "full-audit.xlsx");
  }

  processData();
</script></body>
</html>
