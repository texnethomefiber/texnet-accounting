<!DOCTYPE html><html>
<head>
  <title>TEXNET HOME FIBER Monthly Financial Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f0f4f8;
      color: #333;
    }
    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    .header-box {
      text-align: center;
      padding: 20px;
    }
    .btn-group button {
      margin: 5px;
      padding: 10px 20px;
    }
    canvas {
      max-width: 600px;
      margin: 20px auto;
      display: block;
    }
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex;
      align-items: center; justify-content: center; z-index: 9999;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 10px;
      max-width: 300px; width: 100%; text-align: center;
    }
    select {
      display: block;
      margin: 0 auto;
      padding: 8px;
      font-size: 1rem;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body class="light">
<div id="loginOverlay">
  <div id="loginBox">
    <h3>Enter Password</h3>
    <input type="password" id="loginPassword"><br><br>
    <button onclick="checkPassword()">Login</button>
  </div>
</div><div class="header-box">
  <h1>TEXNET HOME FIBER</h1>
  <h2>Monthly Financial Audit</h2>
  <div class="btn-group">
    <button onclick="toggleTheme()">Toggle Dark/Light</button>
    <button onclick="downloadPDF()">Export to PDF</button>
    <button onclick="downloadExcel()">Export to Excel</button>
  </div>
  <select id="monthSelect" onchange="drawSelectedMonth()"></select>
</div><canvas id="chartCanvas"></canvas>

<script>
  const PASSWORD = "texnet123";
  const INCOME_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=280109793&single=true&output=csv";
  const EXPENSE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=1600049240&single=true&output=csv";

  let incomeMap = {}, expenseMap = {}, months = [];
  let currentChart;

  function checkPassword() {
    const input = document.getElementById("loginPassword").value;
    if (input === PASSWORD) {
      document.getElementById("loginOverlay").style.display = "none";
    } else {
      alert("Incorrect password");
    }
  }

  function toggleTheme() {
    const body = document.body;
    body.className = body.className === "light" ? "dark" : "light";
  }

  function formatMonth(dateStr, withTime = false) {
    const parts = dateStr.split(/[\/\s:]/);
    let date;
    if (withTime) {
      date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    } else {
      date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    }
    return isNaN(date) ? null : date.toLocaleString('default', { month: 'long', year: 'numeric' });
  }

  function processData() {
    Papa.parse(INCOME_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          const month = formatMonth(row.Date, true);
          if (!month) return;
          if (!incomeMap[month]) incomeMap[month] = 0;
          incomeMap[month] += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });

    Papa.parse(EXPENSE_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          const month = formatMonth(row.Date);
          if (!month) return;
          if (!expenseMap[month]) expenseMap[month] = { exp: 0, cost: 0 };
          expenseMap[month].exp += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          expenseMap[month].cost += parseFloat((row["Transaction Cost"] || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });
  }

  function checkReady() {
    if (Object.keys(incomeMap).length && Object.keys(expenseMap).length) {
      populateMonthSelect();
    }
  }

  function populateMonthSelect() {
    const sel = document.getElementById("monthSelect");
    sel.innerHTML = months.sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b))
      .map(m => `<option value="${m}">${m}</option>`).join('');
    drawSelectedMonth();
  }

  function drawSelectedMonth() {
    const month = document.getElementById("monthSelect").value;
    const income = incomeMap[month] || 0;
    const expense = expenseMap[month]?.exp || 0;
    const cost = expenseMap[month]?.cost || 0;

    if (currentChart) currentChart.destroy();

    const ctx = document.getElementById('chartCanvas').getContext('2d');
    currentChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Income', 'Expenditure', 'Transaction Cost'],
        datasets: [{
          label: month,
          data: [income, expense, cost],
          backgroundColor: ['green', 'red', 'orange']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const month = document.getElementById("monthSelect").value;
    const income = incomeMap[month] || 0;
    const expense = expenseMap[month]?.exp || 0;
    const cost = expenseMap[month]?.cost || 0;
    const net = income - expense - cost;
    doc.text(`TEXNET HOME FIBER - Monthly Audit (${month})`, 10, 10);
    doc.text(`Income: Ksh ${income.toFixed(2)}`, 10, 20);
    doc.text(`Expenditure: Ksh ${expense.toFixed(2)}`, 10, 30);
    doc.text(`Transaction Cost: Ksh ${cost.toFixed(2)}`, 10, 40);
    doc.text(`Net: Ksh ${net.toFixed(2)}`, 10, 50);
    doc.save("audit.pdf");
  }

  function downloadExcel() {
    const month = document.getElementById("monthSelect").value;
    const income = incomeMap[month] || 0;
    const expense = expenseMap[month]?.exp || 0;
    const cost = expenseMap[month]?.cost || 0;
    const data = [["Category", "Amount"],
      ["Income", income],
      ["Expenditure", expense],
      ["Transaction Cost", cost],
      ["Net", income - expense - cost]];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Audit");
    XLSX.writeFile(wb, "audit.xlsx");
  }

  processData();
</script></body>
</html>
