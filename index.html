<!DOCTYPE html><html>
<head>
  <title>TEXNET HOME FIBER Monthly Financial Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f0f4f8;
      color: #333;
    }
    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    .header-box {
      text-align: center;
      padding: 20px;
      background-color: #0077cc;
      color: white;
      border-radius: 10px;
      margin: 10px;
    }
    .btn-group button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #0077cc;
      color: white;
      cursor: pointer;
    }
    .btn-group button:hover {
      background-color: #005fa3;
    }
    canvas {
      max-width: 800px;
      margin: 20px auto;
      display: block;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    tr.missing-cost td {
      background-color: #fff3cd;
    }
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex;
      align-items: center; justify-content: center; z-index: 9999;
    }
    #loginBox {
      background: white; padding: 20px; border-radius: 10px;
      max-width: 300px; width: 100%; text-align: center;
    }
    select {
      display: block;
      margin: 0 auto;
      padding: 8px;
      font-size: 1rem;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body class="light">
<div id="loginOverlay">
  <div id="loginBox">
    <h3>Enter Password</h3>
    <input type="password" id="loginPassword"><br><br>
    <button onclick="checkPassword()">Login</button>
  </div>
</div><div id="contentToExport">
  <div class="header-box">
    <h1>TEXNET HOME FIBER</h1>
    <h2>Monthly Financial Audit</h2>
    <div class="btn-group">
      <button onclick="toggleTheme()">Toggle Dark/Light</button>
      <button onclick="toggleChartType()">Toggle Pie/Bar</button>
      <button onclick="downloadPDF()">Export to PDF</button>
      <button onclick="downloadExcel()">Export to Excel</button>
    </div>
    <select id="monthSelect" onchange="drawSelectedMonth()"></select>
  </div><canvas id="chartCanvas"></canvas>

  <table id="summaryTable"></table>
  <h3 style="text-align:center">Income Details</h3>
  <table id="incomeDetails" class="display"></table>
  <h3 style="text-align:center">Expenditure Details</h3>
  <table id="expenditureDetails" class="display"></table>
</div><script>
  const PASSWORD = "texnet123";
  const INCOME_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=280109793&single=true&output=csv";
  const EXPENSE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=1600049240&single=true&output=csv";

  let incomeMap = {}, expenseMap = {}, months = [], allIncome = [], allExpense = [];
  let currentChart;
  let currentChartType = 'bar';

  function checkPassword() {
    const input = document.getElementById("loginPassword").value;
    if (input === PASSWORD) {
      document.getElementById("loginOverlay").style.display = "none";
    } else {
      alert("Incorrect password");
    }
  }

  function toggleTheme() {
    const body = document.body;
    body.className = body.className === "light" ? "dark" : "light";
  }

  function toggleChartType() {
    currentChartType = currentChartType === 'bar' ? 'pie' : 'bar';
    drawSelectedMonth();
  }

  function formatMonth(dateStr) {
    const parts = dateStr.split(/[\/\s:]/);
    if (parts.length < 3) return null;
    const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    return isNaN(date) ? null : date.toLocaleString('default', { month: 'long', year: 'numeric' });
  }

  function processData() {
    Papa.parse(INCOME_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        allIncome = results.data;
        results.data.forEach(row => {
          const month = formatMonth(row.Date);
          if (!month) return;
          if (!incomeMap[month]) incomeMap[month] = 0;
          incomeMap[month] += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });

    Papa.parse(EXPENSE_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        allExpense = results.data;
        results.data.forEach(row => {
          const month = formatMonth(row.Date);
          if (!month) return;
          if (!expenseMap[month]) expenseMap[month] = { exp: 0, cost: 0 };
          expenseMap[month].exp += parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
          expenseMap[month].cost += parseFloat((row["Transaction Cost"] || "0").replace(/[^\d.]/g, "")) || 0;
          if (!months.includes(month)) months.push(month);
        });
        checkReady();
      }
    });
  }

  function checkReady() {
    if (Object.keys(incomeMap).length && Object.keys(expenseMap).length) {
      populateMonthSelect();
    }
  }

  function populateMonthSelect() {
    const sel = document.getElementById("monthSelect");
    sel.innerHTML = months.sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b))
      .map(m => `<option value="${m}">${m}</option>`).join('');
    drawSelectedMonth();
  }

  function drawSelectedMonth() {
    const month = document.getElementById("monthSelect").value;
    const income = incomeMap[month] || 0;
    const expense = expenseMap[month]?.exp || 0;
    const cost = expenseMap[month]?.cost || 0;
    const net = income - expense - cost;

    if (currentChart) currentChart.destroy();

    const ctx = document.getElementById('chartCanvas').getContext('2d');
    currentChart = new Chart(ctx, {
      type: currentChartType,
      data: {
        labels: ['Income', 'Expenditure', 'Transaction Cost'],
        datasets: [{
          label: month,
          data: [income, expense, cost],
          backgroundColor: ['#4caf50', '#f44336', '#ff9800']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: currentChartType === 'pie' } }
      }
    });

    document.getElementById("summaryTable").innerHTML = `
      <thead><tr><th>Category</th><th>Amount (Ksh)</th></tr></thead>
      <tbody>
        <tr><td>Income</td><td>${income.toFixed(2)}</td></tr>
        <tr><td>Expenditure</td><td>${expense.toFixed(2)}</td></tr>
        <tr><td>Transaction Cost</td><td>${cost.toFixed(2)}</td></tr>
        <tr><td><strong>Net</strong></td><td><strong>${net.toFixed(2)}</strong></td></tr>
      </tbody>
    `;

    const incomeTable = $('#incomeDetails');
    const incomeRows = allIncome.filter(r => formatMonth(r.Date) === month).map(r =>
      `<tr><td>${r.Date}</td><td>${r.Name}</td><td>${r.Amount}</td><td>${r.Phone}</td></tr>`
    ).join('');
    incomeTable.html(`<thead><tr><th>Date</th><th>Name</th><th>Amount</th><th>Phone</th></tr></thead><tbody>${incomeRows}</tbody>`);
    if (!$.fn.DataTable.isDataTable('#incomeDetails')) incomeTable.DataTable();

    const expenseTable = $('#expenditureDetails');
    const expenseRows = allExpense.filter(r => formatMonth(r.Date) === month).map(r => {
      const missing = !r["Transaction Cost"] || r["Transaction Cost"].trim() === "";
      return `<tr${missing ? ' class="missing-cost"' : ''}><td>${r.Date}</td><td>${r.Item}</td><td>${r.Amount}</td><td>${r["Transaction Cost"] || "0.00"}</td></tr>`;
    }).join('');
    expenseTable.html(`<thead><tr><th>Date</th><th>Item</th><th>Amount</th><th>Transaction Cost</th></tr></thead><tbody>${expenseRows}</tbody>`);
    if (!$.fn.DataTable.isDataTable('#expenditureDetails')) expenseTable.DataTable();
  }

  async function downloadPDF() {
    const element = document.getElementById("contentToExport");
    const canvas = await html2canvas(element, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("full-audit.pdf");
  }

  function downloadExcel() {
    const month = document.getElementById("monthSelect").value;
    const income = incomeMap[month] || 0;
    const expense = expenseMap[month]?.exp || 0;
    const cost = expenseMap[month]?.cost || 0;
    const data = [["Category", "Amount"],
      ["Income", income],
      ["Expenditure", expense],
      ["Transaction Cost", cost],
      ["Net", income - expense - cost]];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Audit");
    XLSX.writeFile(wb, "audit.xlsx");
  }

  processData();
</script></body>
           </html>
