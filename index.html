
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TEXNET HOME FIBER MONTHLY FINANCIAL AUDIT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f9fd;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      color: #333;
    }
    .header-box {
      border: 2px solid #005792;
      border-radius: 10px;
      padding: 20px;
      background: #e3f2fd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 30px;
    }
    .header-box h1 {
      color: #003865;
      margin: 0;
    }
    .header-box h2 {
      color: #005792;
      margin-top: 10px;
    }
    .summary {
      background: #e3f2fd;
      border-left: 6px solid #2196F3;
      padding: 15px 20px;
      border-radius: 5px;
      margin-top: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .summary p {
      margin: 6px 0;
      font-weight: 500;
    }
    .net-positive { color: green; }
    .net-negative { color: red; }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      border: 1px solid #ccc;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #007acc;
      color: white;
      cursor: pointer;
    }
    .highlight-income { background-color: #e6f9e6; }
    .highlight-expense { background-color: #ffe6e6; }
  </style>
</head>
<body>
  <div class="header-box">
    <h1>TEXNET HOME FIBER</h1>
    <h2>MONTHLY FINANCIAL AUDIT</h2>
  </div>

  <label for="monthSelect">Select Month:</label>
  <select id="monthSelect"></select>

  <div class="summary" id="summary"></div>

  <h3>ðŸ“¥ Income</h3>
  <table id="incomeTable"></table>

  <h3>ðŸ“¤ Expenditure</h3>
  <table id="expenditureTable"></table>

  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    const incomeCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=280109793&single=true&output=csv";
    const expenditureCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=1600049240&single=true&output=csv";

    let incomeData = {}, expenditureData = {};

    function parseCSV(url, callback) {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: results => {
          const cleaned = results.data.map(row => {
            const newRow = {};
            for (const k in row) {
              newRow[k.trim().replace(/ï»¿/g, '')] = row[k];
            }
            return newRow;
          });
          callback(cleaned);
        }
      });
    }

    function formatMonth(dateStr) {
      const match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!match) return null;
      const [_, day, month, year] = match;
      const date = new Date(`${month}/${day}/${year}`);
      return isNaN(date) ? null : date.toLocaleString('default', { month: 'long', year: 'numeric' });
    }

    function groupByMonth(data, dateKey) {
      const grouped = {};
      data.forEach(row => {
        const month = formatMonth(row[dateKey]);
        if (!month) return;
        if (!grouped[month]) grouped[month] = [];
        grouped[month].push(row);
      });
      return grouped;
    }

    function renderTables(month) {
      const incomeTable = document.getElementById("incomeTable");
      const expenditureTable = document.getElementById("expenditureTable");
      const summary = document.getElementById("summary");
      const incomes = incomeData[month] || [];
      const expenses = expenditureData[month] || [];

      let totalIncome = 0, totalExpense = 0, totalCost = 0;

      incomeTable.innerHTML = "<tr><th>Date</th><th>Name</th><th>Amount</th><th>Phone</th></tr>";
      incomes.forEach(row => {
        let amount = parseFloat((row.Amount || "").replace(/Ksh|,/g, "").trim()) || 0;
        totalIncome += amount;
        incomeTable.innerHTML += `
          <tr class="\${amount >= 10000 ? 'highlight-income' : ''}">
            <td>\${row.Date}</td><td>\${row.Name}</td><td>Ksh \${amount.toFixed(2)}</td><td>\${row.Phone}</td>
          </tr>`;
      });

      expenditureTable.innerHTML = "<tr><th>Date</th><th>Item</th><th>Amount</th><th>Transaction Cost</th></tr>";
      expenses.forEach(row => {
        let amount = parseFloat((row.Amount || "").replace(/Ksh|,/g, "").trim()) || 0;
        let cost = parseFloat((row["Transaction Cost"] || "").replace(/Ksh|,/g, "").trim()) || 0;
        totalExpense += amount;
        totalCost += cost;
        expenditureTable.innerHTML += `
          <tr class="\${amount >= 5000 ? 'highlight-expense' : ''}">
            <td>\${row.Date}</td><td>\${row.Item}</td><td>Ksh \${amount.toFixed(2)}</td><td>Ksh \${cost.toFixed(2)}</td>
          </tr>`;
      });

      const net = totalIncome - totalExpense - totalCost;
      summary.innerHTML = `
        <h3>Summary for \${month}</h3>
        <p><strong>Total Income:</strong> Ksh \${totalIncome.toFixed(2)}</p>
        <p><strong>Total Expenditure:</strong> Ksh \${totalExpense.toFixed(2)}</p>
        <p><strong>Transaction Costs:</strong> Ksh \${totalCost.toFixed(2)}</p>
        <p><strong>Net Balance:</strong> <span class="\${net >= 0 ? 'net-positive' : 'net-negative'}">Ksh \${net.toFixed(2)}</span></p>`;
    }

    function populateMonthSelect() {
      const months = new Set([...Object.keys(incomeData), ...Object.keys(expenditureData)]);
      const sorted = Array.from(months).sort((a, b) => new Date(a) - new Date(b));
      const select = document.getElementById("monthSelect");
      select.innerHTML = sorted.map(m => `<option value="\${m}">\${m}</option>`).join("");
      select.onchange = () => renderTables(select.value);
      if (sorted.length) {
        select.value = sorted[sorted.length - 1];
        renderTables(select.value);
      }
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const incomeEl = document.getElementById("incomeTable");
      const expEl = document.getElementById("expenditureTable");
      const incomeWS = XLSX.utils.table_to_sheet(incomeEl);
      const expenseWS = XLSX.utils.table_to_sheet(expEl);
      XLSX.utils.book_append_sheet(wb, incomeWS, "Income");
      XLSX.utils.book_append_sheet(wb, expenseWS, "Expenditure");
      XLSX.writeFile(wb, "Financial_Audit.xlsx");
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("TEXNET HOME FIBER MONTHLY FINANCIAL AUDIT", 14, 20);
      const summary = document.getElementById("summary");
      doc.autoTable({ html: summary, startY: 30, theme: 'plain' });

      doc.addPage();
      doc.text("Income", 14, 20);
      doc.autoTable({ html: "#incomeTable", startY: 30 });

      doc.addPage();
      doc.text("Expenditure", 14, 20);
      doc.autoTable({ html: "#expenditureTable", startY: 30 });

      doc.save("Financial_Audit.pdf");
    }

    parseCSV(incomeCSV, data => {
      incomeData = groupByMonth(data, "Date");
      parseCSV(expenditureCSV, data2 => {
        expenditureData = groupByMonth(data2, "Date");
        populateMonthSelect();
      });
    });
  </script>
</body>
</html>
