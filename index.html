<!DOCTYPE html><html>
<head>
  <title>TEXNET HOME FIBER MONTHLY FINANCIAL AUDIT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      color: #333;
    }
    .header-box {
      background-color: #007acc;
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-bottom: 30px;
    }
    .header-box h1 {
      margin: 0;
      font-size: 1.8em;
    }
    .header-box h2 {
      margin: 5px 0 0;
      font-size: 1.2em;
      font-weight: normal;
    }
    h3 {
      margin-top: 40px;
      color: #00406b;
    }
    label, select {
      display: block;
      margin-top: 10px;
    }
    select {
      padding: 10px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 300px;
    }
    .summary {
      background: #e3f2fd;
      border-left: 6px solid #2196F3;
      padding: 15px 20px;
      border-radius: 5px;
      margin-top: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .summary p {
      margin: 6px 0;
      font-weight: 500;
    }
    .btn-group {
      margin: 20px 0;
    }
    .btn-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      margin-right: 10px;
      cursor: pointer;
      background-color: #007acc;
      color: white;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    th, td {
      text-align: left;
      padding: 12px 14px;
    }
    th {
      background-color: #007acc;
      color: #fff;
      font-weight: 600;
      border-bottom: 2px solid #005f99;
      cursor: pointer;
    }
    td {
      border-bottom: 1px solid #f0f0f0;
    }
    tr:nth-child(even) td {
      background-color: #f9fbfc;
    }
    tr:hover td {
      background-color: #e6f4ff;
    }
    tr.highlight-income {
      background-color: #e6f9e6 !important;
    }
    tr.highlight-expense {
      background-color: #ffe6e6 !important;
    }
  </style>
</head>
<body>
  <div class="header-box">
    <h1>TEXNET HOME FIBER</h1>
    <h2>MONTHLY FINANCIAL AUDIT</h2>
  </div><label for="monthSelect">Select Month:</label> <select id="monthSelect"></select>

  <div class="btn-group">
    <button onclick="exportToPDF()">Export to PDF</button>
    <button onclick="exportToExcel()">Export to Excel</button>
  </div>  <div class="summary" id="summary"></div>
  <h3>ðŸ“¥ Income</h3>
  <table id="incomeTable"></table>
  <h3>ðŸ“¤ Expenditure</h3>
  <table id="expenditureTable"></table>  <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>  <script>
    const incomeCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=280109793&single=true&output=csv";
    const expenditureCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=1600049240&single=true&output=csv";
    let incomeData = {}, expenditureData = {}, currentMonth = "";
    const sortStates = { income: {}, expense: {} };

    function formatMonth(dateStr) {
      const match = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!match) return null;
      const [_, day, month, year] = match;
      const date = new Date(`${year}-${month}-${day}`);
      return isNaN(date) ? null : date.toLocaleString('default', { month: 'long', year: 'numeric' });
    }

    function parseCSV(url, callback) {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: results => {
          const cleaned = results.data.map(row => {
            const cleanRow = {};
            Object.keys(row).forEach(k => cleanRow[k.trim()] = row[k]);
            return cleanRow;
          });
          callback(cleaned);
        }
      });
    }

    function groupByMonth(data, key) {
      const grouped = {};
      data.forEach(row => {
        const month = formatMonth(row[key]);
        if (!month) return;
        grouped[month] = grouped[month] || [];
        grouped[month].push(row);
      });
      return grouped;
    }

    function sortTable(type, key) {
      const data = type === 'income' ? incomeData[currentMonth] : expenditureData[currentMonth];
      const isAmount = key.toLowerCase().includes('amount') || key === 'Transaction Cost';
      const direction = sortStates[type][key] = !sortStates[type][key];
      data.sort((a, b) => {
        let aVal = a[key] || "", bVal = b[key] || "";
        if (isAmount) {
          aVal = parseFloat(aVal.replace(/[^\d.]/g, "")) || 0;
          bVal = parseFloat(bVal.replace(/[^\d.]/g, "")) || 0;
        } else {
          aVal = aVal.toString().toLowerCase();
          bVal = bVal.toString().toLowerCase();
        }
        return direction ? (aVal > bVal ? 1 : aVal < bVal ? -1 : 0) : (aVal < bVal ? 1 : aVal > bVal ? -1 : 0);
      });
      renderTables(currentMonth);
    }

    function renderTables(month) {
      currentMonth = month;
      const income = incomeData[month] || [];
      const expense = expenditureData[month] || [];
      let totalIncome = 0, totalExpense = 0, totalCost = 0;

      const incomeTable = document.getElementById("incomeTable");
      incomeTable.innerHTML = `<thead><tr>
        <th onclick="sortTable('income', 'Date')">Date</th>
        <th onclick="sortTable('income', 'Name')">Name</th>
        <th onclick="sortTable('income', 'Amount')">Amount</th>
        <th onclick="sortTable('income', 'Phone')">Phone</th>
      </tr></thead>`;
      income.forEach(row => {
        const amount = parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
        totalIncome += amount;
        incomeTable.innerHTML += `<tr><td>${row.Date}</td><td>${row.Name}</td><td>Ksh ${amount.toFixed(2)}</td><td>${row.Phone}</td></tr>`;
      });

      const expTable = document.getElementById("expenditureTable");
      expTable.innerHTML = `<thead><tr>
        <th onclick="sortTable('expense', 'Date')">Date</th>
        <th onclick="sortTable('expense', 'Item')">Item</th>
        <th onclick="sortTable('expense', 'Amount')">Amount</th>
        <th onclick="sortTable('expense', 'Transaction Cost')">Transaction Cost</th>
      </tr></thead>`;
      expense.forEach(row => {
        const amount = parseFloat((row.Amount || "0").replace(/[^\d.]/g, "")) || 0;
        const cost = parseFloat((row["Transaction Cost"] || "0").replace(/[^\d.]/g, "")) || 0;
        totalExpense += amount;
        totalCost += cost;
        expTable.innerHTML += `<tr><td>${row.Date}</td><td>${row.Item}</td><td>Ksh ${amount.toFixed(2)}</td><td>Ksh ${cost.toFixed(2)}</td></tr>`;
      });

      const net = totalIncome - totalExpense - totalCost;
      document.getElementById("summary").innerHTML = `
        <h3>Summary for ${month}</h3>
        <p><strong>Total Income:</strong> Ksh ${totalIncome.toFixed(2)}</p>
        <p><strong>Total Expenditure:</strong> Ksh ${totalExpense.toFixed(2)}</p>
        <p><strong>Transaction Costs:</strong> Ksh ${totalCost.toFixed(2)}</p>
        <p><strong>Net Balance:</strong> Ksh ${net.toFixed(2)}</p>`;
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("TEXNET HOME FIBER", 15, 15);
      doc.setFontSize(12);
      doc.text("MONTHLY FINANCIAL AUDIT - " + currentMonth, 15, 25);

      let summary = document.getElementById("summary").innerText.split("\n");
      summary.forEach((line, i) => doc.text(line, 15, 40 + i * 8));

      doc.addPage();
      doc.text("Income Details", 15, 15);
      doc.autoTable({ html: "#incomeTable", startY: 25 });

      doc.addPage();
      doc.text("Expenditure Details", 15, 15);
      doc.autoTable({ html: "#expenditureTable", startY: 25 });

      doc.save(`Financial_Audit_${currentMonth.replace(/\s+/g, "_")}.pdf`);
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const summaryText = document.getElementById("summary").innerText.split("\n").map(line => [line]);
      const wsSummary = XLSX.utils.aoa_to_sheet(summaryText);
      XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

      const incomeRows = [...document.querySelectorAll("#incomeTable tr")].map(row => [...row.children].map(cell => cell.innerText));
      const wsIncome = XLSX.utils.aoa_to_sheet(incomeRows);
      XLSX.utils.book_append_sheet(wb, wsIncome, "Income");

      const expRows = [...document.querySelectorAll("#expenditureTable tr")].map(row => [...row.children].map(cell => cell.innerText));
      const wsExp = XLSX.utils.aoa_to_sheet(expRows);
      XLSX.utils.book_append_sheet(wb, wsExp, "Expenditure");

      XLSX.writeFile(wb, `Financial_Audit_${currentMonth.replace(/\s+/g, "_")}.xlsx`);
    }

    function populateMonthSelect() {
      const allMonths = new Set([...Object.keys(incomeData), ...Object.keys(expenditureData)]);
      const sorted = [...allMonths].sort((a, b) => new Date(a) - new Date(b));
      const select = document.getElementById("monthSelect");
      select.innerHTML = sorted.map(m => `<option value="${m}">${m}</option>`).join("");
      select.onchange = () => renderTables(select.value);
      if (sorted.length) {
        select.value = sorted.at(-1);
        renderTables(select.value);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      parseCSV(incomeCSV, data => {
        incomeData = groupByMonth(data, "Date");
        parseCSV(expenditureCSV, exp => {
          expenditureData = groupByMonth(exp, "Date");
          populateMonthSelect();
        });
      });
    });
  </script></body>
</html>
